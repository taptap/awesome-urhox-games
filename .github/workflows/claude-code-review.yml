name: Claude Code Review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    # 只在 PR 评论中触发，且评论包含 @claude
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude')
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR branch
        run: |
          gh pr checkout ${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic requests

      - name: Download UrhoX AI Dev Kit
        run: |
          mkdir -p /tmp/ai-dev-kit
          curl -L -o /tmp/ai-dev-kit.zip "https://urhox-demo-platform.spark.xd.com/ai-dev-kit/pd/stable/ai-dev-kit.zip"
          unzip -o /tmp/ai-dev-kit.zip -d /tmp/ai-dev-kit

      - name: Get PR diff
        id: pr_diff
        run: |
          gh pr diff ${{ github.event.issue.number }} > /tmp/pr_diff.patch
          echo "diff_file=/tmp/pr_diff.patch" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed files
        id: changed_files
        run: |
          gh pr view ${{ github.event.issue.number }} --json files -q '.files[].path' > /tmp/changed_files.txt
          echo "files_list=/tmp/changed_files.txt" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Code Review
        id: claude_review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python .github/scripts/claude_review.py

      - name: Post review comment
        if: always()
        run: |
          if [ -f /tmp/review_result.md ]; then
            gh pr comment ${{ github.event.issue.number }} --body-file /tmp/review_result.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

